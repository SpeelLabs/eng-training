---
description: データを取得したら、より見やすく、扱いやすくするために結果を整形することがよくあります。この章では、検索結果の整形や加工の方法について学びます。
---

# 5. 検索結果の整形

## 5. 検索結果の整形

#### 5.1 結果の整形

**5.1.1 別名 (エイリアス) の使用**

`AS` キーワードを使用して、結果の列名にエイリアスを付けることができます。

```sql
-- カラムに日本語の別名を付ける
SELECT 
    name AS 商品名,
    price AS 価格,
    stock AS 在庫数
FROM products;
```

<details>

<summary>実行結果</summary>

```
+--------------------+----------+--------+
| 商品名              | 価格      | 在庫数  |
+--------------------+----------+--------+
| スマートフォン       |    89000 |     25 |
| ラップトップPC       |   120000 |     15 |
| コーヒーメーカー      |    15000 |     30 |
+--------------------+----------+--------+
3 rows in set (0.00 sec)
```

</details>

> 📝 **ポイント**: `AS`キーワードは省略可能ですが、可読性のためには明示的に`AS`を書く方が良いでしょう。特に複雑なクエリや計算式では`AS`を使うことをお勧めします。

**5.1.2 重複行の排除 (DISTINCT)**

重複する行を排除したい場合は、`DISTINCT` キーワードを使用します。

```sql
-- カテゴリー ID の一覧 (重複なし) を取得
SELECT DISTINCT category_id FROM products;
```

<details>

<summary>実行結果</summary>

```
+-------------+
| category_id |
+-------------+
|           1 |
|           2 |
|           3 |
+-------------+
3 rows in set (0.00 sec)
```

</details>

> 📝 **ポイント**: `DISTINCT` は便利ですが、大きなデータセットでは処理に時間がかかることがあります。必要な場合のみ使用しましょう。また、`DISTINCT` は `SELECT` の直後にだけ使用できます。

**5.1.3 結果の並べ替え (ORDER BY)**

`ORDER BY`句を使用すると、特定の列の値に基づいて結果を並べ替えることができます：

```sql
-- 価格の安い順に商品を表示
SELECT name, price
FROM products
ORDER BY price;
```

<details>

<summary>実行結果</summary>

```
+----------------------+----------+
| name                 | price    |
+----------------------+----------+
| マウス                |     2000 |
| キーボード            |     6000 |
| コーヒーメーカー       |    15000 |
| スマートフォン         |    89000 |
| ラップトップPC         |   120000 |
+----------------------+----------+
5 rows in set (0.00 sec)
```

</details>

降順 (大きい順) に並べ替えるには、`DESC` キーワードを使います。

```sql
-- 価格の高い順に商品を表示
SELECT name, price
FROM products
ORDER BY price DESC;
```

<details>

<summary>実行結果</summary>

```
+----------------------+----------+
| name                 | price    |
+----------------------+----------+
| ラップトップPC  　     |   120000 |
| スマートフォン    　    |    89000 |
| コーヒーメーカー    　  |    15000 |
| キーボード             |     6000 |
| マウス                |     2000 |
+----------------------+----------+
5 rows in set (0.00 sec)
```

</details>

複数の列で並べ替えることもできます。

```sql
-- 在庫の多い順、同じ在庫数なら価格の高い順に並べ替え
SELECT name, stock, price
FROM products
ORDER BY stock DESC, price DESC;
```

> 📝 **ポイント**: `ORDER BY` で複数列を指定する場合、先に指定した列で最初に並べ替え、値が同じレコード同士の中で次の列で並べ替えます。実務ではこの機能を使って、例えば 「部門別売上高順」 や 「顧客ごとの購入金額順」 など、グループ分けしつつ順位付けした結果を得られます。

**5.1.4 結果の制限 (LIMIT)**

`LIMIT` 句を使うと、返される行数を制限できます。

```sql
-- 価格の高い上位 3つの商品
SELECT name, price
FROM products
ORDER BY price DESC
LIMIT 3;
```

<details>

<summary>実行結果</summary>

```
+----------------------+----------+
| name                 | price    |
+----------------------+----------+
| ラップトップPC         |   120000 |
| スマートフォン         |    89000 |
| コーヒーメーカー        |    15000 |
+----------------------+----------+
3 rows in set (0.00 sec)
```

</details>

特定の位置から始めて数行を取得するには、`OFFSET` を使用します。

```sql
-- 価格の高い順で 4番目と 5番目の商品
SELECT name, price
FROM products
ORDER BY price DESC
LIMIT 2 OFFSET 3;
```

<details>

<summary>実行結果</summary>

```
+-------------+--------+
| name        | price  |
+-------------+--------+
| キーボード   |   6000 |
| マウス       |   2000 |
+-------------+--------+
2 rows in set (0.00 sec)
```

</details>

> 📝 **ポイント**: `LIMIT` は省略形で `LIMIT [OFFSET,] row_count` という形式も使えます。例:  `LIMIT 3, 2` は `LIMIT 2 OFFSET 3` と同じです。`LIMIT` は大きなデータセットから一部だけを取得するのに非常に有用ですが、必ず`ORDER BY`と一緒に使いましょう。

#### 5.2 計算フィールドと関数 ⭐️

**5.2.1 計算フィールド**

SELECT クエリー内で計算を実行できます。

```sql
-- 商品の合計金額 (価格 × 在庫数)
SELECT 
    name, 
    price, 
    stock, 
    price * stock AS 合計金額
FROM products;
```

<details>

<summary>実行結果</summary>

```
+--------------------+----------+-------+------------+
| name               | price    | stock | 合計金額   |
+--------------------+----------+-------+------------+
| スマートフォン        |    89000 |    25 |    2225000 |
| ラップトップPC       |   120000 |    15 |    1800000 |
| コーヒーメーカー      |    15000 |    30 |     450000 |
| キーボード           |     6000 |    20 |     120000 |
| マウス              |     2000 |    30 |      60000 |
+--------------------+----------+-------+------------+
5 rows in set (0.00 sec)
```

</details>

```sql
-- 税込価格 (10%)
SELECT 
    name, 
    price AS 税抜価格, 
    ROUND(price * 1.1) AS 税込価格
FROM products;
```

<details>

<summary>実行結果</summary>

```
+--------------------+----------+------------+
| name               | 税抜価格  | 税込価格    |
+--------------------+----------+------------+
| スマートフォン       |    89000 |      97900 |
| ラップトップPC       |   120000 |     132000 |
| コーヒーメーカー      |    15000 |      16500 |
| キーボード           |     6000 |       6600 |
| マウス              |     2000 |       2200 |
+--------------------+----------+------------+
5 rows in set (0.00 sec)
```

</details>

> 📝 **ポイント**: 計算フィールドは既存のデータを基に新しい値を生成するため、データベースのテーブルには保存されません。クエリーを実行するたびに計算されます。計算結果が小数になる場合は、ROUND 関数で丸めると日本円などの整数表示が必要な場合に便利です。

**5.2.2 数値関数 ⭐️**

数値を操作するための関数もあります。

```sql
-- 四捨五入とフォーマット
SELECT
    name,
    price,
    ROUND(price, -3) AS 千円単位に丸める,
    FORMAT(price, 0) AS カンマ区切り
FROM products;
```

<details>

<summary>実行結果</summary>

```
+--------------------+----------+------------------+----------------+
| name               | price    | 千円単位に丸める    | カンマ区切り     |
+--------------------+----------+------------------+----------------+
| スマートフォン        |    89000 |            89000 | 89,000         |
| ラップトップPC       |   120000 |           120000 | 120,000        |
| コーヒーメーカー      |    15000 |            15000 | 15,000         |
| キーボード           |     6000 |             6000 | 6,000          |
| マウス              |     2000 |             2000 | 2,000          |
+--------------------+----------+------------------+----------------+
5 rows in set (0.00 sec)
```

</details>

> 📝 **ポイント**: `ROUND` 関数の 2つ目のパラメータは、丸める桁数を指定します。正の値は小数点以下の桁数、負の値は整数部分の桁数を表します。例えば、`ROUND(1234, -2)` は `1200` になります。`FORMAT` 関数はカンマ区切りの文字列を生成するので、金額表示に便利です。

**5.2.3 条件関数 (CASE式)  ⭐️**

`CASE` 式を使うと、条件に基づいて異なる値を返すことができます。

```sql
-- 価格帯による分類
SELECT 
    name, 
    price,
    CASE 
        WHEN price < 5000 THEN '低価格'
        WHEN price < 50000 THEN '中価格'
        ELSE '高価格'
    END AS 価格帯
FROM products;
```

<details>

<summary>実行結果</summary>

```
+--------------------+----------+----------+
| name               | price    | 価格帯   |
+--------------------+----------+----------+
| スマートフォン       |    89000 | 高価格   |
| ラップトップPC       |   120000 | 高価格   |
| コーヒーメーカー     |    15000 | 中価格   |
| キーボード          |     6000 | 中価格   |
| マウス              |     2000 | 低価格   |
+--------------------+----------+----------+
5 rows in set (0.00 sec)
```

</details>

```sql
-- 在庫状況の表示
SELECT 
    name, 
    stock,
    CASE 
        WHEN stock = 0 THEN '在庫切れ'
        WHEN stock < 10 THEN '残りわずか'
        ELSE '在庫あり'
    END AS 在庫状況
FROM products;
```

> 📝 **ポイント**: `CASE` 式は条件分岐を行い、条件に応じた値を返します。条件は上から順に評価され、最初に一致した条件の値が返されます。実務ではレポートやデータ分析で広く使われます。

#### 5.3 NULL 値の処理 ⭐️

**5.3.1 IFNULL 関数**

NULL 値を別の値に置き換えるには、`IFNULL` 関数を使用します。

```sql
-- 説明が NULL の場合は「詳細情報なし」と表示
SELECT 
    name, 
    IFNULL(description, '詳細情報なし') AS 説明
FROM products;
```

<details>

<summary>実行結果</summary>

```
+--------------------+----------------------+
| name               | 説明                 |
+--------------------+----------------------+
| スマートフォン        | 最新型スマホ          |
| ラップトップPC        | 高性能ノートPC        |
| コーヒーメーカー      | 全自動コーヒーマシン    |
| キーボード           | 詳細情報なし          |
| マウス              | 詳細情報なし          |
+--------------------+----------------------+
5 rows in set (0.00 sec)
```

</details>

> 📝 **ポイント**: NULL 値は 「値が存在しない」 ことを表す特別な値です。計算や表示の際に問題を引き起こすことがあるため、`IFNULL` 関数を使って適切に処理することが重要です。特にレポート作成時には、NULL 値が 「0」 や 「空白」 として表示されるよう変換するとよいでしょう。



***

### 演習問題

**問題 5-1: エイリアスの使用**

商品情報を見やすく表示するために、以下のクエリーを作成してください。

商品の名前、価格、在庫数をそれぞれ 「商品名」 「価格」 「在庫数」 という列名で表示する

<details>

<summary>解答</summary>

```sql
-- 商品情報を日本語列名で表示
SELECT
    name AS 商品名,
    price AS 価格,
    stock AS 在庫数
FROM products;
```

</details>

**問題 5-2: 重複行の排除 (DISTINCT)**

商品テーブルにある異なるカテゴリー ID のリストを表示するクエリを作成してください。

<details>

<summary>解答</summary>

```sql
-- 異なるカテゴリIDのリスト
SELECT DISTINCT category_id
FROM products;
```

</details>

**問題 5-3: 結果の並べ替え (ORDER BY)**

以下のクエリーを作成してください。

1. 商品を価格の高い順に並べ替えて表示する
2. 在庫数が多い順に並べ、同じ在庫数の場合は価格の高い順に並べる

<details>

<summary>解答</summary>

```sql
-- 1. 価格の高い順
SELECT name, price
FROM products
ORDER BY price DESC;

-- 2. 在庫数が多い順、同じなら価格の高い順
SELECT name, stock, price
FROM products
ORDER BY stock DESC, price DESC;
```

</details>

**問題 5-4: 結果の制限 (LIMIT)**

価格の高い上位 3つの商品を表示するクエリを作成してください。

<details>

<summary>解答</summary>

```sql
-- 価格の高い上位3つの商品
SELECT name, price
FROM products
ORDER BY price DESC
LIMIT 3;
```

</details>

**問題 5-5: 計算フィールドの使用 ⭐️**

以下のクエリーを作成してください。

1. 各商品の税込価格 (10%) を表示する (整数で表示)
2. 各商品の合計金額 (価格 × 在庫数) を計算し、合計金額の大きい順に表示する
3. 在庫の状況を 「在庫なし」 「残りわずか (10個未満)」 「在庫あり」 で表示する

<details>

<summary>解答</summary>

```sql
-- 1. 税込価格（整数表示）
SELECT
    name AS 商品名,
    price AS 税抜価格,
    ROUND(price * 1.1) AS 税込価格
FROM products;

-- 2. 合計金額の計算
SELECT
    name AS 商品名,
    price AS 単価,
    stock AS 在庫数,
    price * stock AS 合計金額
FROM products
ORDER BY 合計金額 DESC;

-- 3. 在庫状況の表示
SELECT
    name AS 商品名,
    stock AS 在庫数,
    CASE
        WHEN stock = 0 THEN '在庫切れ'
        WHEN stock < 10 THEN '残りわずか'
        ELSE '在庫あり'
    END AS 在庫状況
FROM products;
```

</details>
